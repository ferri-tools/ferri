# Walkthrough: Creating a Custom Ferri Flow for Full Codebase Review

This walkthrough guides you through creating and running a custom Ferri flow. The goal of this flow is to package the entire codebase, send it to the Gemini Pro model for a comprehensive code review, and save the output to a file.

## Goal

Automate a full-repo code review using a multi-step Ferri flow that:
1.  Archives the current state of the git repository.
2.  Passes that archive to a powerful remote model for analysis.
3.  Saves the analysis to a text file.

## Prerequisites

1.  **Ferri Initialized:** You must have a Ferri project initialized (`ferri init`).
2.  **Gemini Pro Model Registered:** You need a registered `gemini-pro` model. If you haven't done this, follow these steps from the `README.md`:

    ```bash
    # 1. Store your Google API key
    ferri secrets set GOOGLE_API_KEY "your-api-key-here"

    # 2. Register the Gemini Pro model with the alias 'gemini-pro'
    ferri models add gemini-pro \
      --provider google \
      --api-key-secret GOOGLE_API_KEY \
      --model-name gemini-pro
    ```

## Step 1: Create the Flow Definition File

Ferri flows are defined in YAML files. We will create a new flow that defines the two steps of our process: packaging the code and running the review.

Create a new file named `gemini_code_review.yml` in the `pm/` directory with the following content:

```yaml
name: "Gemini Full Repo Code Review"
jobs:
  - id: package-codebase
    # This command uses git to create a clean tarball of the repository's source code.
    # It avoids including the .git directory, build artifacts, and respects .gitignore.
    command: 'git archive --format=tar -o codebase.tar HEAD'
  - id: run-review
    # This job depends on the 'package-codebase' job completing successfully.
    dependencies: [package-codebase]
    # This command executes the core logic:
    # - `ferri with`: Runs a synchronous command with context.
    # - `--model gemini-pro`: Specifies our powerful remote model.
    # - `--ctx codebase.tar`: Adds the entire archived codebase as context.
    # - `"Perform a comprehensive code review..."`: The prompt for the AI.
    # - `> gemini_review.txt`: Redirects the model's output to a file.
    command: 'ferri with --model gemini-pro --ctx codebase.tar "Perform a comprehensive code review of the entire codebase provided in the tarball. Focus on architecture, potential bugs, and suggest improvements." > gemini_review.txt'
```

*(This file has already been created for you in `pm/gemini_code_review.yml`)*

## Step 2: Run the Flow

Now that the flow is defined, you can execute it with the `ferri flow run` command.

```bash
ferri flow run pm/gemini_code_review.yml
```

Ferri will now execute the jobs defined in the YAML file in the correct order. You will see output indicating that the `package-codebase` job runs first, followed by the `run-review` job.

## Step 3: Expected Outcome

After the flow completes, you will find two new files in your project's root directory:

1.  `codebase.tar`: A tarball archive of your git repository.
2.  `gemini_review.txt`: A text file containing the detailed code review generated by the Gemini Pro model.

You can now inspect the `gemini_review.txt` file to see the results of the AI-powered analysis.

# 04: Parallel Processing and Merge Flow

This flow demonstrates how to run jobs in parallel and then aggregate their results in a final "merge" job. This is a common and efficient pattern for tasks that can be broken down into independent pieces of work, such as data processing, testing, or batch analysis.

## How It Works

1.  **`generate-pros` and `generate-cons` Jobs:** These two jobs are defined with no dependencies, so the Ferri flow engine can run them **in parallel**.
    -   `generate-pros` asks an AI to list the advantages of using Rust and saves them to `pros.txt`.
    -   `generate-cons` asks an AI to list the disadvantages of using Rust and saves them to `cons.txt`.

2.  **`create-report` Job:** This is the "merge" or "fan-in" job.
    -   It has a `needs` block that lists both `generate-pros` and `generate-cons`. This ensures that it will only start after **both** parallel jobs have completed successfully.
    -   Its step uses the `cat` command to concatenate the two title files (`title.txt`, `pros.txt`, `cons.txt`) into a single, final report named `full_report.md`.

## State Management

-   **Multiple Artifacts:** The state is distributed across multiple files (`pros.txt`, `cons.txt`).
-   **Aggregation:** The `create-report` job is responsible for reading all the individual artifacts and combining them into a final, unified output. This pattern is highly scalable; you could have dozens of parallel jobs, and a single final job could aggregate all their results.

## How to Run

This flow uses a remote model (`gemini-pro`).

### Prerequisites

1.  **Google API Key:** You need a Google API key with the Gemini API enabled.

### Execution

The following commands are fully self-contained. They will create a temporary workspace, configure the necessary secrets and models, and then run the flow.

```bash
# 1. Create a temporary directory and navigate into it.
mkdir -p /tmp/flow-tests/04-parallel-merge && cd /tmp/flow-tests/04-parallel-merge

# 2. Initialize a new ferri workspace.
ferri init

# 3. Set the required secret. Replace "YOUR_KEY" with your actual Google API key.
ferri secrets set GOOGLE_API_KEY "YOUR_KEY"

# 4. Add the required model to the workspace's registry.
ferri models add gemini-pro \
  --provider google \
  --api-key-secret GOOGLE_API_KEY \
  --model-name gemini-2.5-pro

# 5. Create the flow YAML file in the current directory.
cat <<'EOF' > 04-parallel-merge-flow.yml
# This flow runs two AI jobs in parallel and then merges their outputs into a single final report.
apiVersion: ferri.flow/v1alpha1
kind: Flow
metadata:
  name: parallel-ai-analysis-and-merge
spec:
  jobs:
    generate-pros:
      name: "Analyze Advantages of Rust"
      steps:
        - name: "Use Gemini to list the pros"
          run: "ferri with --model gemini-pro --output pros.txt -- 'List and briefly explain three major advantages of programming in Rust.'"

    generate-cons:
      name: "Analyze Disadvantages of Rust"
      steps:
        - name: "Use Gemini to list the cons"
          run: "ferri with --model gemini-pro --output cons.txt -- 'List and briefly explain three major disadvantages or challenges of programming in Rust.'"

    create-report:
      name: "Create Final Report"
      needs:
        - generate-pros
        - generate-cons
      steps:
        - name: "Combine pros and cons into a single markdown file"
          run: |
            echo '# Analysis of Rust: Pros and Cons' > full_report.md
            echo '' >> full_report.md
            echo '## Advantages' >> full_report.md
            cat pros.txt >> full_report.md
            echo '' >> full_report.md
            echo '## Disadvantages' >> full_report.md
            cat cons.txt >> full_report.md
            echo '' >> full_report.md
            echo '---' >> full_report.md
            echo 'Report generated by Ferri AI flow.' >> full_report.md
EOF

# 6. Run the flow.
ferri flow run 04-parallel-merge-flow.yml
```
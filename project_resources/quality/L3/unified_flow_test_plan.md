# Ferri Layer 3 (L3) Manual Test Plan: Unified Flow Monitoring

## 1. Introduction

This document provides a step-by-step manual testing plan for the unified flow monitoring system, a Layer 3 (L3) feature. The goal is to verify that both the agentic `ferri do` command and the manual `ferri flow run` command provide an identical, real-time TUI monitoring experience.

This test will confirm that the new log-based architecture successfully decouples the flow orchestrator from the command-line interface, providing a consistent user experience for all flow executions.

## 2. Prerequisites

Before starting, ensure you have the following:
- `ferri` compiled and available in your system's `PATH`.
- A Google AI API key for testing the `ferri do` agent.
- A clean directory for a new test project.

## 3. Test Execution

### Part 1: Project Setup

This part verifies that a new Ferri project can be created and configured for agentic commands.

1.  **Create a test directory and navigate into it:**
    ```bash
    mkdir ferri-l3-test
    cd ferri-l3-test
    ```

2.  **Initialize the project:**
    ```bash
    ferri init
    ```
    - **Expected Result:** The command should initialize a `.ferri` directory successfully.

3.  **Set the Gemini API Key:**
    *Replace `YOUR_GEMINI_API_KEY` with your actual key.*
    ```bash
    ferri secrets set GEMINI_API_KEY "YOUR_GEMINI_API_KEY"
    ```
    - **Expected Result:** The command should succeed without error. This is required for the `ferri do` command to function.

### Part 2: `ferri do` Execution and Monitoring

This part tests the monitoring experience for a dynamically generated flow.

1.  **Execute a multi-step agentic command:**
    ```bash
    ferri do "create a rust project named 'my-app' and then compile it"
    ```
    - **Expected Result:**
        1. The agent will first print that it is generating a flow.
        2. A full-screen TUI will appear.
        3. The TUI will list two jobs (e.g., `create-project` and `build-project`).
        4. The status of each job will update in real-time (e.g., `⏳ Pending` -> `⚙️ Running` -> `✅ Succeeded`).
        5. The TUI will exit automatically once the final job is complete.
        6. A new directory named `my-app` will exist in the current folder.

2.  **Verify Log Creation:**
    - **Action:** List the contents of the `.ferri/runs/` directory.
    - **Expected Result:** A new log file (e.g., `create-and-build-rust-project-16...log`) should exist. This file contains the raw execution log that the TUI used.

### Part 3: `ferri flow run` Execution and Monitoring

This part tests the monitoring experience for a pre-existing flow file, verifying the experience is identical to Part 2.

1.  **Identify the Generated Flow File:**
    - **Action:** List the contents of the `.ferri/do/` directory. Find the YAML file that was generated by the previous `ferri do` command (e.g., `flow-16...yml`).

2.  **Execute the flow file manually:**
    *Replace `<path-to-your-flow-file.yml>` with the actual filename from the previous step.*
    ```bash
    ferri flow run .ferri/do/<path-to-your-flow-file.yml>
    ```
    - **Expected Result:**
        1. The **exact same** full-screen TUI from Part 2 will appear.
        2. It will again show the two jobs and their real-time status updates.
        3. The TUI will exit automatically upon completion.

3.  **Verify Log Creation:**
    - **Action:** List the contents of the `.ferri/runs/` directory again.
    - **Expected Result:** A **second** new log file should now exist, corresponding to this manual run.

### Part 4: Log File Inspection

This part verifies that the logs are being written correctly.

1.  **Inspect a log file:**
    *Choose one of the log files created in the `.ferri/runs/` directory.*
    ```bash
    cat .ferri/runs/<your-log-file-name.log>
    ```
    - **Expected Result:** The file should contain a series of single-line JSON objects. Each line represents a status update and should be parsable as a JSON object containing keys like `"job"` with `"jobId"` and `"status"`.

## 4. Conclusion

If all the above steps completed with the expected results, the L3 unified flow monitoring system is verified. This plan confirms that `ferri do` and `ferri flow run` provide a consistent, reliable, and observable user experience, backed by a persistent logging mechanism.
